#!/bin/bash

echo "Mounting proxy file system ..."
if mount -t smbfs -o read-only -o username=administrator,password=f10urm111 //proxy/C$ /proxy
then
        date
        echo "proxy mounted successfully"
else
        echo "ERROR - exiting"
        exit 2
fi

echo "Retrieving Malware logfiles from proxy ..."
rsync -rav "/proxy/Trend Micro/IMSS/mque/tmp/" /root/proxy-malware-df-files

if cd /root/proxy-malware-df-files
then
        :
else
        exit 2
fi

#echo "============================================================="
#ls -tr | while read fname
#do
#       grep XMailFrom $fname | awk '{print $2}'
#       grep "^T\>" $fname | awk -F\< '{print $2}'
#       echo --
#done

echo "============================================================="
echo
echo "          XMailFrom ADDRESSES"
echo "          -------------------"
grep XMailFrom * | awk '{print $2}' | sort | uniq -c | sort -nr

#echo
#echo
#echo "         From ADDRESSES"
#echo "         -------------------"
#grep "^F\>" * | awk -F\< '{print $2}' | sed 's/>//g' | sort | uniq -c | sort -nr

echo
echo
echo "          TO ADDRESSES"
echo "          ------------"
grep "^T\>" * | awk -F\< '{print $2}' | sed 's/>//g' | sort | uniq -c | sort -nr


echo
echo
echo "          OLDEST FILE"
echo "          -----------"
ls -lt | tail -1

echo
echo
echo "          NEWEST FILE"
echo "          -----------"
ls -ltr | tail -1

echo
echo

echo "Unmounting Proxy filesystem ..."
if umount /proxy
then
        date
        echo "proxy unmounted successfully"
else
        echo "ERROR"
        exit 2
fi

# EOF